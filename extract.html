<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestionnaire de vid√©os JSON - IMSSA 68</title>
<style>
body { 
    font-family: 'Segoe UI', Tahoma, sans-serif; 
    margin: 20px; 
    background-image: url("img/BG.svg"); 
    color: #333; 
    font-size: 16px; 
    line-height: 1.4;
}

h2 { 
    color: #0C5073; 
    margin-bottom: 25px; 
    text-align: center;
}

.controls-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 25px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.branch-creator {
    display: grid;
    grid-template-columns: 1fr 1fr auto auto;
    gap: 15px;
    align-items: end;
    margin-bottom: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 5px;
    font-weight: 600;
    color: #555;
}

input, select, textarea { 
    padding: 10px; 
    border-radius: 6px; 
    border: 1px solid #ddd; 
    font-size: 14px;
    font-family: inherit;
    box-sizing: border-box;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #1AA9BE;
    box-shadow: 0 0 0 2px rgba(26, 169, 190, 0.2);
}

button { 
    padding: 10px 20px; 
    border-radius: 6px; 
    border: none; 
    background-color: #1AA9BE; 
    color: white; 
    cursor: pointer; 
    font-size: 14px; 
    font-weight: 600;
    transition: all 0.3s;
    white-space: nowrap;
}

button:hover { 
    background-color: #0C5073; 
    transform: translateY(-1px);
}

.btn-success {
    background-color: #28a745;
}

.btn-success:hover {
    background-color: #218838;
}

.cards-container {
    display: grid;
    gap: 20px;
}

.card { 
    background: #fff; 
    padding: 20px; 
    border-radius: 12px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
    transition: all 0.3s;
    position: relative;
    border: 1px solid #eee;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.card-title {
    font-size: 16px;
    font-weight: 600;
    color: #0C5073;
}

.card-form {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.card input, .card select { 
    width: 100%;
    margin: 0;
}

.preview {
    margin-top: 15px;
    border-radius: 8px;
    overflow: hidden;
    background: #f8f9fa;
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
}

.preview iframe { 
    width: 100%; 
    height: 200px; 
    border: none;
}

.preview.empty {
    font-style: italic;
    border: 2px dashed #ddd;
}

.supprimer { 
    background-color: #e74c3c; 
    padding: 8px 12px;
    font-size: 12px;
}

.supprimer:hover { 
    background-color: #c0392b; 
}

.json-section {
    margin-top: 30px;
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
}

.json-section h3 {
    color: #0C5073;
    margin-top: 0;
}

textarea { 
    width: 100%; 
    font-family: 'Consolas', 'Monaco', monospace; 
    font-size: 12px; 
    border-radius: 8px; 
    resize: vertical;
    background: #fff;
}

.status-message {
    padding: 10px;
    border-radius: 6px;
    margin-top: 10px;
    font-weight: 600;
}

.status-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.loading {
    text-align: center;
    padding: 20px;
    color: #666;
}

@media (max-width: 768px) {
    .branch-creator {
        grid-template-columns: 1fr;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    body {
        margin: 10px;
        font-size: 14px;
    }
}
</style>
</head>
<body>
<h2>Gestionnaire de vid√©os JSON - IMSSA 68</h2>

<div class="controls-section">
    <div class="branch-creator">
        <div class="form-group">
            <label for="parentPath">Chemin parent existant :</label>
            <select id="parentPath">
                <option value="">Racine</option>
            </select>
        </div>
        <div class="form-group">
            <label for="newBranchName">Nouveau nom de branche :</label>
            <input type="text" id="newBranchName" placeholder="Ex: Nouvelle cat√©gorie">
        </div>
        <button onclick="ajouterBranche()" class="btn-success">+ Cr√©er branche</button>
        <button onclick="supprimerBranche()" style="background-color: #dc3545;">üóëÔ∏è Supprimer branche</button>
    </div>
</div>

<div id="loadingMessage" class="loading">Chargement des donn√©es...</div>
<div id="cardsContainer" class="cards-container" style="display: none;"></div>

<div class="json-section">
    <button onclick="genererJSON()">üîÑ G√©n√©rer JSON et copier</button>
    <button id="ajouterBtn">+ Ajouter une vid√©o</button>
    <div id="statusMessage"></div>
    
    <h3>Aper√ßu du JSON g√©n√©r√© :</h3>
    <textarea id="resultJSON" rows="15" readonly placeholder="Le JSON g√©n√©r√© appara√Ætra ici..."></textarea>
</div>

<script>
window.addEventListener("beforeunload", function (e) {
    // Message personnalis√© (affichage d√©pend du navigateur)
    e.preventDefault();
    e.returnValue = "Voulez-vous vraiment quitter cette page ? Vos modifications pourraient √™tre perdues.";
});
</script>

<script>
let jsonData = {}; 
let isDataLoaded = false;

// Chargement des donn√©es JSON
async function chargerDonnees() {
    try {
        const response = await fetch('videos.json');
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        jsonData = await response.json();
        isDataLoaded = true;
        
        // Mise √† jour de l'interface
        mettreAJourChemins();
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('cardsContainer').style.display = 'block';
        
        afficherMessage("Donn√©es charg√©es avec succ√®s !", "success");
    } catch (error) {
        console.error("Erreur lors du chargement des donn√©es :", error);
        
        // Initialiser avec des donn√©es vides si le fichier n'existe pas
        jsonData = {};
        isDataLoaded = true;
        
        mettreAJourChemins();
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('cardsContainer').style.display = 'block';
        
        afficherMessage("Aucun fichier JSON trouv√©. D√©marrage avec des donn√©es vides.", "error");
    }
}

// Mise √† jour de la liste des chemins disponibles
function mettreAJourChemins() {
    const select = document.getElementById('parentPath');
    select.innerHTML = '<option value="">Racine</option>';
    
    function ajouterChemins(obj, chemin = '') {
        Object.keys(obj).forEach(key => {
            const nouveauChemin = chemin ? `${chemin} > ${key}` : key;
            select.innerHTML += `<option value="${nouveauChemin}">${nouveauChemin}</option>`;
            
            if (typeof obj[key] === 'object' && !Array.isArray(obj[key])) {
                ajouterChemins(obj[key], nouveauChemin);
            }
        });
    }
    
    ajouterChemins(jsonData);
}

// Cr√©ation d'une nouvelle branche
function ajouterBranche() {
    const parentPath = document.getElementById('parentPath').value;
    const newBranchName = document.getElementById('newBranchName').value.trim();
    
    if (!newBranchName) {
        afficherMessage("Veuillez saisir un nom pour la nouvelle branche.", "error");
        return;
    }
    
    // Navigation vers l'objet parent
    let current = jsonData;
    if (parentPath) {
        const pathParts = parentPath.split(' > ');
        for (const part of pathParts) {
            if (!current[part]) current[part] = {};
            current = current[part];
        }
    }
    
    // Cr√©ation de la nouvelle branche
    if (!current[newBranchName]) {
        // Si on est √† la racine, cr√©er un objet
        // Sinon (sous-cat√©gorie), cr√©er un tableau pour les vid√©os
        if (!parentPath) {
            current[newBranchName] = {};
        } else {
            current[newBranchName] = [];
        }
        
        mettreAJourChemins();
        mettreAJourSelectsCategories(); // Mettre √† jour les selects existants
        document.getElementById('newBranchName').value = '';
        afficherMessage(`Branche "${newBranchName}" cr√©√©e avec succ√®s !`, "success");
    } else {
        afficherMessage(`La branche "${newBranchName}" existe d√©j√†.`, "error");
    }
}

// Suppression d'une branche
function supprimerBranche() {
    const parentPath = document.getElementById('parentPath').value;
    
    if (!parentPath) {
        afficherMessage("S√©lectionnez une branche √† supprimer.", "error");
        return;
    }
    
    if (!confirm(`√ätes-vous s√ªr de vouloir supprimer la branche "${parentPath}" et tout son contenu ?`)) {
        return;
    }
    
    const pathParts = parentPath.split(' > ');
    const brancheName = pathParts.pop();
    
    // Navigation vers l'objet parent
    let current = jsonData;
    for (const part of pathParts) {
        current = current[part];
    }
    
    // Suppression de la branche
    delete current[brancheName];
    
    mettreAJourChemins();
    mettreAJourSelectsCategories();
    document.getElementById('parentPath').value = '';
    afficherMessage(`Branche "${parentPath}" supprim√©e avec succ√®s !`, "success");
}

// Mise √† jour des selects de cat√©gories existants
function mettreAJourSelectsCategories() {
    const categories = genererOptionsCategories();
    document.querySelectorAll('.categorie').forEach(select => {
        const selectedValue = select.value;
        select.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        
        // R√©tablir la s√©lection si elle existe encore
        if (categories.includes(selectedValue)) {
            select.value = selectedValue;
        }
    });
}
function afficherMessage(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.className = `status-message status-${type}`;
    statusDiv.textContent = message;
    
    setTimeout(() => {
        statusDiv.textContent = '';
        statusDiv.className = '';
    }, 5000);
}

// G√©n√©ration des options de cat√©gories
function genererOptionsCategories() {
    const options = [];
    
    function parcourir(obj, chemin = '') {
        Object.keys(obj).forEach(key => {
            const nouveauChemin = chemin ? `${chemin} > ${key}` : key;
            
            if (Array.isArray(obj[key])) {
                // Si c'est un tableau, c'est une cat√©gorie finale (sous-cat√©gorie)
                options.push(nouveauChemin);
            } else if (typeof obj[key] === 'object') {
                // Si c'est un objet, continuer √† parcourir mais ne pas l'ajouter comme option
                parcourir(obj[key], nouveauChemin);
            }
        });
    }
    
    parcourir(jsonData);
    return [...new Set(options)]; // Supprimer les doublons
}

// Ajout d'une carte vid√©o
function ajouterCard() {
    if (!isDataLoaded) {
        afficherMessage("Veuillez attendre le chargement des donn√©es.", "error");
        return;
    }
    
    const container = document.getElementById('cardsContainer');
    const categories = genererOptionsCategories();
    
    if (categories.length === 0) {
        afficherMessage("Aucune cat√©gorie disponible. Cr√©ez d'abord une branche.", "error");
        return;
    }
    
    const cardId = 'card_' + Date.now();
    
    const div = document.createElement('div');
    div.className = 'card';
    div.id = cardId;
    div.innerHTML = `
        <div class="card-header">
            <div class="card-title">Nouvelle vid√©o</div>
            <button class="supprimer" onclick="supprimerCard('${cardId}')">üóëÔ∏è Supprimer</button>
        </div>
        <div class="card-form">
            <input type="text" placeholder="Titre de la vid√©o" class="titre" onchange="updateCardTitle('${cardId}')">
            <div class="form-row">
                <input type="text" placeholder="Collez n'importe quel lien YouTube ici" class="iframe" oninput="updatePreview('${cardId}')">
                <select class="categorie">
                    ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                </select>
            </div>
            <div class="preview empty">
                Aucun aper√ßu disponible - Collez un lien YouTube
            </div>
        </div>
    `;
    
    container.appendChild(div);
    
    // Focus sur le champ titre
    div.querySelector('.titre').focus();
}

// Mise √† jour du titre de la carte
function updateCardTitle(cardId) {
    const card = document.getElementById(cardId);
    const titre = card.querySelector('.titre').value;
    const titleElement = card.querySelector('.card-title');
    
    if (titre.trim()) {
        titleElement.textContent = titre;
    } else {
        titleElement.textContent = 'Nouvelle vid√©o';
    }
}

// Extraction de l'ID YouTube depuis n'importe quel type de lien
function extractYouTubeId(url) {
    try {
        const parsedUrl = new URL(url);
        // Cas 1 : youtube.com/watch?v=...
        if (parsedUrl.hostname.includes("youtube.com")) {
            if (parsedUrl.searchParams.has("v")) {
                return parsedUrl.searchParams.get("v");
            }
            // Cas 2 : shorts
            if (parsedUrl.pathname.startsWith("/shorts/")) {
                return parsedUrl.pathname.split("/")[2];
            }
            // Cas 3 : embed d√©j√† en place
            if (parsedUrl.pathname.startsWith("/embed/")) {
                return parsedUrl.pathname.split("/")[2];
            }
        }
        // Cas 4 : youtu.be/ID
        if (parsedUrl.hostname === "youtu.be") {
            return parsedUrl.pathname.substring(1); // enl√®ve le "/"
        }
    } catch (e) {
        console.error("URL invalide :", url);
    }
    return null;
}

// Conversion vers URL embed
function toEmbedUrl(url) {
    const videoId = extractYouTubeId(url);
    if (videoId) {
        return "https://www.youtube-nocookie.com/embed/" + videoId;
    }
    return null;
}

// R√©cup√©ration du titre r√©el de la vid√©o YouTube
async function obtenirTitreYouTube(videoId) {
    try {
        // Essayer d'extraire le titre depuis l'API oEmbed de YouTube
        const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`);
        if (response.ok) {
            const data = await response.json();
            return data.title;
        }
    } catch (error) {
        console.error('Erreur lors de la r√©cup√©ration du titre YouTube:', error);
    }
    
    // Fallback: utiliser l'ID nettoy√© comme avant
    return decodeURIComponent(videoId).replace(/[-_]/g, ' ');
}
// Mise √† jour de l'aper√ßu vid√©o
function updatePreview(cardId) {
    const card = document.getElementById(cardId);
    const input = card.querySelector('.iframe');
    const previewDiv = card.querySelector('.preview');
    const inputValue = input.value.trim();
    
    if (!inputValue) {
        previewDiv.className = 'preview empty';
        previewDiv.innerHTML = 'Aucun aper√ßu disponible - Collez un lien YouTube ici';
        return;
    }
    
    // Essayer d'extraire l'URL embed
    let embedUrl = null;
    
    // Si c'est d√©j√† un iframe, extraire l'URL src
    const iframeSrcMatch = inputValue.match(/src="([^"]+)"/);
    if (iframeSrcMatch) {
        embedUrl = iframeSrcMatch[1];
    } else {
        // Sinon, traiter comme un lien YouTube normal
        embedUrl = toEmbedUrl(inputValue);
    }
    
    if (embedUrl) {
        previewDiv.className = 'preview';
        previewDiv.innerHTML = `<iframe src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`;
        
        // Stocker l'URL embed pour la g√©n√©ration JSON
        input.dataset.embedUrl = embedUrl;
    } else {
        previewDiv.className = 'preview empty';
        previewDiv.innerHTML = 'URL YouTube non reconnue - V√©rifiez le format';
        input.dataset.embedUrl = '';
    }
}

// Suppression d'une carte
function supprimerCard(cardId) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer cette vid√©o ?')) {
        document.getElementById(cardId).remove();
        afficherMessage("Vid√©o supprim√©e.", "success");
    }
}

// G√©n√©ration du JSON final
function genererJSON() {
    const newJson = JSON.parse(JSON.stringify(jsonData));
    let compteurVideos = 0;
    let erreurs = [];
    
    document.querySelectorAll('.card').forEach(card => {
        const titre = card.querySelector('.titre').value.trim();
        const input = card.querySelector('.iframe');
        const categorieComplete = card.querySelector('.categorie').value;
        
        if (!titre || !input.value.trim() || !categorieComplete) {
            erreurs.push('Une ou plusieurs cartes ont des champs manquants');
            return;
        }
        
        // R√©cup√©rer l'URL embed depuis le dataset ou la calculer
        let embedUrl = input.dataset.embedUrl;
        if (!embedUrl) {
            embedUrl = toEmbedUrl(input.value.trim());
        }
        
        if (!embedUrl) {
            erreurs.push(`URL YouTube invalide pour la vid√©o "${titre}"`);
            return;
        }
        
        try {
            // Navigation vers la cat√©gorie appropri√©e
            const pathParts = categorieComplete.split(' > ');
            let current = newJson;
            
            // Naviguer jusqu'au dernier niveau
            for (let i = 0; i < pathParts.length; i++) {
                const part = pathParts[i];
                if (i === pathParts.length - 1) {
                    // Dernier niveau : doit √™tre un tableau pour les vid√©os
                    if (!current[part]) current[part] = [];
                    if (!Array.isArray(current[part])) {
                        current[part] = [];
                    }
                    current[part].push({ titre, url: embedUrl });
                } else {
                    // Niveau interm√©diaire : doit √™tre un objet
                    if (!current[part]) current[part] = {};
                    current = current[part];
                }
            }
            
            compteurVideos++;
        } catch (error) {
            erreurs.push(`Erreur lors du traitement de la vid√©o "${titre}": ${error.message}`);
        }
    });
    
    const jsonText = JSON.stringify(newJson, null, 2);
    document.getElementById('resultJSON').value = jsonText;
    
    if (erreurs.length > 0) {
        afficherMessage(`Erreurs d√©tect√©es: ${erreurs.join(', ')}`, "error");
        return;
    }
    
    if (compteurVideos === 0) {
        afficherMessage("Aucune vid√©o valide √† traiter.", "error");
        return;
    }
    
    // Copie dans le presse-papier
    navigator.clipboard.writeText(jsonText).then(() => {
        afficherMessage(`JSON g√©n√©r√© avec ${compteurVideos} vid√©o(s) et copi√© dans le presse-papier !`, "success");
    }).catch(err => {
        console.error('Erreur lors de la copie:', err);
        afficherMessage(`JSON g√©n√©r√© avec ${compteurVideos} vid√©o(s). Erreur lors de la copie.`, "error");
    });
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('ajouterBtn').addEventListener('click', ajouterCard);
    chargerDonnees();
});
</script>
</body>
</html>
