<!doctype html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Recherchez parmi tous les exercices du cabinet IMSSA 68 Mulhouse. Trouvez rapidement les vid√©os d'exercices kin√© et sport qui vous int√©ressent.">
    <meta name="robots" content="noindex">

    <link rel="stylesheet" href="css/reset.css"> <!-- CSS reset -->
    <link rel="stylesheet" href="css/style.css"> <!-- Resource style -->
    <script src="js/modernizr.js"></script> <!-- Modernizr -->

    <!-- FAVICON -->
    <link rel="icon" href="img/logoIMSSA.ico" type="image/x-icon">

    <title>Recherche - IMSSA 68 Mulhouse</title>
    
    <!-- CF resultats.js si fuse ne fonctionne plus -->

    <style>
        /* Style pour le titre principal */
        #titre {
            margin-top: 50px;
            text-align: center;
            font-size: 2em;
        }

        /* Style pour les titres avec boutons favoris */
        .video-header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            text-align: center;
            margin-bottom: 20px;
        }

        .video-header h3 {
            font-size: 1.5em;
            margin: 0;
        }

        /* Style bouton favoris */
        .fav-btn {
            background-color: #111433;
            color: white;
            font-size: 1.2em;
            border: none;
            padding: 0.3em 0.3em;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            flex-shrink: 0;
        }

        .fav-btn:hover {
            background-color: #0C5073;
        }

        .video {
            border-bottom: 1px solid #111433;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .video:last-child {
            border-bottom: none;
        }

        iframe {
            width: 80%;
            max-width: 900px;
            height: 500px;
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: block;
            margin: 0 auto;
        }

        #contenu {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .search-info {
            text-align: center;
            margin: 20px 0;
            font-size: 1.1em;
            color: #666;
        }

        .video-meta {
            text-align: center;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #888;
        }

        .loading {
            text-align: center;
            font-size: 1.2em;
            color: #111433;
            margin: 50px 0;
        }

        .no-results {
            text-align: center;
            font-size: 1.1em;
            color: #666;
            margin: 50px 0;
        }
    </style>
</head>

<body>
    <header>
        <div class="navbar">
            <div>
                <a href="/" class="nav__logo">
                    <img src="img/logoIMSSA.ico" alt="logo IMSSA" id="logo_header"> IMSSA accueil
                </a>
            </div>
            <div class="cd-dropdown-wrapper">

                <a href="/exercices-favoris" id="btn-fav" class="navbar-btn">‚ù§Ô∏è</a>
                <a href="#0" id="btn-google" class="navbar-btn">üîí</a>

                <!--		 DROPDOWN		 -->
                <a class="cd-dropdown-trigger" href="#0">Menu</a>
                <nav class="cd-dropdown">
                    <h2>Menu</h2>
                    <a href="#0" class="cd-close">Fermer</a>
                    <ul class="cd-dropdown-content">
                        <li> <a href="/">Accueil</a> </li>

                        <li>
							<form class="cd-search" action="/recherche" method="get">
								<input type="search" name="q" placeholder=" üîç Rechercher...">
							</form>
						</li>

                        <li id="menu"></li>

                        <li class="cd-divider">Autre</li>

                        <li class="has-children">
                            <a href="#0">Contact</a>
                            <ul class="cd-dropdown-icons is-hidden">
                                <li class="go-back"><a href="#0">Contact</a></li>
                                <li>
                                    <a class="cd-dropdown-item item-1" target="_blank"
                                        href="https://www.instagram.com/imssa68?utm_source=ig_web_button_share_sheet">
                                        <h3>Instagram</h3>
                                        <p>Retrouvez nous sur Instagram</p>
                                    </a>
                                </li>

                                <li>
                                    <a class="cd-dropdown-item item-2" href="#0">
                                        <h3>TikTok</h3>
                                        <p>Retrouvez nous sur TikTok</p>
                                    </a>
                                </li>

                                <li>
                                    <a class="cd-dropdown-item item-3" href="mailto:imssa68@gmail.com">
                                        <h3>Mail</h3>
                                        <p>Nous contacter par mail</p>
                                    </a>
                                </li>

                                <li>
                                    <a class="cd-dropdown-item item-4" target="_blank"
                                        href="https://imssa.monrdvkine.fr">
                                        <h3>MonRdvKin√©</h3>
                                        <p>Prendre rendez-vous</p>
                                    </a>
                                    </li>

                                <li>
                                    <a class="cd-dropdown-item item-5" href="tel:+33658906142">
                                        <h3>T√©l√©phone</h3>
                                        <p>+33 6 58 90 61 42</p>
                                    </a>
                                </li>

                                <li>
                                    <a class="cd-dropdown-item item-6" target="_blank"
                                        href="https://www.google.fr/maps/place/IMSSA+Institut+M√©dico-Sportif+Sud+Alsace/@47.7314575,7.3131683,16z/data=!3m1!4b1!4m6!3m5!1s0x47919bc25e3f6491:0xdd3ad8e21621fc7b!8m2!3d47.7314539!4d7.3157432!16s%2Fg%2F11fsm1b_fz?entry=ttu&g_ep=EgoyMDI1MDkwOC4wIKXMDSoASAFQAw%3D%3D">
                                        <h3>Google Map</h3>
                                        <p>Acc√©der √† Google Map</p>
                                    </a>
                                </li>

                            </ul> <!-- .cd-dropdown-icons -->
                        </li> <!-- .has-children -->
                    </ul> <!-- .cd-dropdown-content -->
                </nav> <!-- .cd-dropdown -->
            </div> <!-- .cd-dropdown-wrapper -->
        </div>
    </header>

    <!--			 MAIN			 -->

    <main class="cd-main-content">
        <h1 id="titre">R√©sultats de recherche</h1>
        <div class="search-info" id="search-info"></div>
        <div id="contenu">
            <div class="loading" id="loading">üîç Recherche en cours...</div>
        </div>
    </main>

    <script src="js/jquery-2.1.1.js"></script>
    <script src="js/jquery.menu-aim.js"></script> <!-- menu aim -->
    <script src="js/main.js"></script> <!-- Resource jQuery -->

    <footer class="site-footer">
        <p>¬© 2025 IMSSA 68 ‚Äì Tous droits r√©serv√©s</p>
        <p>Centre sportif r√©gional d'Alsace , 5 Rue des Fr√®res Lumi√®re, 68200 Mulhouse</p>
        <a target="_blank" href="https://imssa.monrdvkine.fr/Accueil/ContactCabinet/imssa">Contact</a> | <a
            target="_blank" href="/mentions-legales">Mentions l√©gales</a>
    </footer>

    <!------------------------------------------- Chargement du menu dynamique -->
    <script>
        fetch("videos.json")
            .then(res => res.json())
            .then(data => {
                const menu = document.getElementById("menu");

                for (const grandCategorie in data) {
                    const li = document.createElement("li");
                    li.classList.add("has-children");

                    // Nom de la grande cat√©gorie
                    li.innerHTML = `<a href="#0">${grandCategorie}</a>`;

                    // Sous-menu
                    const ulSecond = document.createElement("ul");
                    ulSecond.classList.add("cd-secondary-dropdown", "is-hidden");
                    ulSecond.innerHTML = `
        <li class="go-back"><a href="#0">Menu</a></li>
		<li class="see-all">
		<a href="/tous-les-exercices?categorie=${encodeURIComponent(grandCategorie)}">
			Tous les exercices
		</a>
		</li>
      `;

                    const sousCategories = data[grandCategorie];
                    for (const sousCat in sousCategories) {
                        const liSous = document.createElement("li");
                        liSous.classList.add("has-children");
                        liSous.innerHTML = `<a href="#0">${sousCat}</a>`;

                        const ulVideos = document.createElement("ul");
                        ulVideos.classList.add("is-hidden");
                        ulVideos.innerHTML = `
          <li class="go-back"><a href="#0">Retour</a></li>
          <li class="see-all">
			  <a href="/voir-plus?categorie=${encodeURIComponent(grandCategorie)}&souscat=${encodeURIComponent(sousCat)}">
			    Voir tout
			  </a>
			</li>
        `;

                        sousCategories[sousCat].forEach(video => {
                            const liVideo = document.createElement("li");
                            liVideo.classList.add("video-item");
                            liVideo.innerHTML = `<a href="/video?url=${encodeURIComponent(video.url)}&titre=${encodeURIComponent(video.titre)}">${video.titre}</a>`;
                            ulVideos.appendChild(liVideo);
                        });

                        liSous.appendChild(ulVideos);
                        ulSecond.appendChild(liSous);
                    }

                    li.appendChild(ulSecond);
                    menu.insertAdjacentElement("beforebegin", li);
                }

                menu.remove();

                if (typeof window.reinitializeDropdownEvents === 'function') {
                    window.reinitializeDropdownEvents();
                }
            });
    </script>

    <!------------------------------------------- Script de recherche avec Fuse.js -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script>
        async function loadVideos() {
            try {
                const response = await fetch("videos.json");
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const videosData = await response.json();

                // Transformer en tableau plat
                const videos = [];
                for (const categorie in videosData) {
                    for (const branche in videosData[categorie]) {
                        videosData[categorie][branche].forEach(video => {
                            videos.push({
                                titre: video.titre,
                                url: video.url,
                                categorie,
                                branche
                            });
                        });
                    }
                }

                return videos;
            } catch (error) {
                console.error("Erreur lors du chargement des vid√©os:", error);
                throw error;
            }
        }

        async function searchVideos(query) {
            const videos = await loadVideos();

            // Config Fuse.js optimis√©e
            const options = {
                keys: [
                    { name: "titre", weight: 0.7 },
                    { name: "categorie", weight: 0.2 },
                    { name: "branche", weight: 0.1 }
                ],
                threshold: 0.3,
                includeScore: true,
                minMatchCharLength: 2
            };

            const fuse = new Fuse(videos, options);
            return fuse.search(query).map(result => result.item);
        }

        // Fonction principale de recherche
        async function performSearch() {
            const params = new URLSearchParams(window.location.search);
            const query = params.get("q");
            const loading = document.getElementById("loading");
            const contenu = document.getElementById("contenu");
            const searchInfo = document.getElementById("search-info");

            if (!query || query.trim() === "") {
                loading.style.display = "none";
                searchInfo.innerHTML = "Aucun terme de recherche fourni.";
                contenu.innerHTML = `<div class="no-results">
                    <p>Veuillez saisir un terme de recherche.</p>
                    <p><a href="/">‚Üê Retour √† l'accueil</a></p>
                </div>`;
                return;
            }

            // Afficher les informations de recherche
            searchInfo.innerHTML = `Recherche pour : <strong>"${query}"</strong>`;

            try {
                const results = await searchVideos(query);
                loading.style.display = "none";

                if (results.length > 0) {
                    contenu.innerHTML = ""; // Vider le contenu
                    searchInfo.innerHTML += ` - ${results.length} r√©sultat(s) trouv√©(s)`;

                    // Limiter √† 10 r√©sultats pour √©viter la surcharge
                    results.slice(0, 10).forEach(video => {
                        // Extraction de l'ID YouTube depuis l'URL embed
                        let videoId = "";
                        if (video.url && video.url.includes("embed/")) {
                            videoId = video.url.split("embed/")[1].split(/[?&]/)[0];
                        }

                        const videoDiv = document.createElement("div");
                        videoDiv.className = "video";
                        videoDiv.innerHTML = `
                            <div class="video-meta">
                                ${video.categorie} ‚Ä∫ ${video.branche}
                            </div>
                            <div class="video-header">
                                <h3>${video.titre}</h3>
                                <button class="fav-btn" data-id="${videoId}" data-label="${video.titre}">ü©∂</button>
                            </div>
                            <iframe src="${video.url}" allowfullscreen loading="lazy"></iframe>
                        `;
                        contenu.appendChild(videoDiv);
                    });

                    // Initialiser les boutons favoris apr√®s ajout
                    if (typeof initAllButtons === "function") {
                        setTimeout(initAllButtons, 200);
                    }

                } else {
                    contenu.innerHTML = `<div class="no-results">
                        <p>Aucun r√©sultat trouv√© pour ¬´ <strong>${query}</strong> ¬ª</p>
                        <p>Essayez avec d'autres mots-cl√©s ou <a href="/">retournez √† l'accueil</a></p>
                    </div>`;
                }

            } catch (error) {
                console.error("Erreur lors de la recherche:", error);
                loading.style.display = "none";
                contenu.innerHTML = `<div class="no-results">
                    <p>‚ùå Erreur lors de la recherche</p>
                    <p>Veuillez r√©essayer ou <a href="/">retourner √† l'accueil</a></p>
                </div>`;
            }
        }

        // Lancer la recherche
        performSearch();
    </script>

    <!------------------------------------------- Script Firebase pour les favoris -->
    <script type="module">
        // 1) Imports Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signInWithPopup,
            GoogleAuthProvider,
            signOut
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // 2) Config Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA7r18GtsCIi1n2AoaBFG-lAYyBPXFIw4Q",
            authDomain: "imssa-2d3cb.firebaseapp.com",
            projectId: "imssa-2d3cb",
            storageBucket: "imssa-2d3cb.appspot.com",
            messagingSenderId: "976927404721",
            appId: "1:976927404721:web:3484dd21e9e52a1e692890",
            measurementId: "G-SKTEPM9LKC"
        };

        // 3) Initialisation Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables globales pour g√©rer l'√©tat
        let currentUser = null;
        let userFavorites = [];
        let buttonsInitialized = false;

        // 4) Gestion du bouton Google Sign-In / Sign-Out
        const btnGoogle = document.getElementById("btn-google");
        btnGoogle.addEventListener("click", () => {
            if (!currentUser) {
                signInWithPopup(auth, new GoogleAuthProvider()).catch(console.error);
            } else {
                if (confirm("Voulez-vous vraiment vous d√©connecter ?")) {
                    signOut(auth).catch(console.error);
                }
            }
        });

        // 5) Fonction pour initialiser tous les boutons favoris
        function initAllButtons() {
            document.querySelectorAll(".fav-btn").forEach(btn => {
                const { id, label } = btn.dataset;
                if (id && label) {
                    // Mettre √† jour l'affichage
                    btn.textContent = userFavorites.some(f => f.id === id) ? "‚ù§Ô∏è" : "ü©∂";
                    // Ajouter l'event listener
                    btn.onclick = () => toggleFavori(id, label, btn);
                }
            });
            buttonsInitialized = true;
        }
        window.initAllButtons = initAllButtons;
        // 6) Observer pour d√©tecter les nouveaux boutons ajout√©s dynamiquement
        const observer = new MutationObserver((mutations) => {
            let newButtonsAdded = false;
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(node => {
                    if (node.nodeType === 1) { // Element node
                        if (node.classList?.contains('fav-btn') || node.querySelector?.('.fav-btn')) {
                            newButtonsAdded = true;
                        }
                    }
                });
            });

            if (newButtonsAdded && currentUser !== null) {
                setTimeout(initAllButtons, 100);
            }
        });

        // D√©marrer l'observation des changements DOM
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });

        // 7) √âcoute de l'√©tat de connexion
        const largeurEcran = window.innerWidth;
        onAuthStateChanged(auth, async user => {
            currentUser = user;

            if (user) {
                if (largeurEcran > 1024) {
                    btnGoogle.textContent = `üë§ ${user.displayName}`;
                } else {
                    btnGoogle.textContent = `üë§`;
                }

                // R√©cup√©rer les favoris
                try {
                    const ref = doc(db, "users", user.uid);
                    const snap = await getDoc(ref);
                    userFavorites = snap.exists() ? snap.data().favoris : [];
                } catch (error) {
                    console.error("Erreur lors de la r√©cup√©ration des favoris:", error);
                    userFavorites = [];
                }
            } else {
                if (largeurEcran > 1024) {
                    btnGoogle.textContent = "üîí Se connecter";
                } else {
                    btnGoogle.textContent = `üîí`;
                }
                userFavorites = [];
            }

            // Initialiser tous les boutons existants
            initAllButtons();
        });

        // 8) Fonction de gestion des favoris
        async function toggleFavori(id, label, btn) {
            if (!currentUser) {
                alert("Connectez-vous d'abord pour g√©rer vos favoris.");
                return;
            }

            try {
                const ref = doc(db, "users", currentUser.uid);
                const idx = userFavorites.findIndex(f => f.id === id);

                if (idx !== -1) {
                    userFavorites.splice(idx, 1);
                } else {
                    userFavorites.push({ id, label });
                }

                // Sauvegarde en base
                await setDoc(ref, { favoris: userFavorites }, { merge: true });

                // Mise √† jour imm√©diate du bouton
                btn.textContent = idx !== -1 ? "ü©∂" : "‚ù§Ô∏è";

            } catch (error) {
                console.error("Erreur lors de la mise √† jour des favoris:", error);
                alert("Erreur lors de la sauvegarde. Veuillez r√©essayer.");
            }
        }

        // Exposer la fonction globalement pour l'utiliser depuis d'autres scripts
        window.initAllButtons = initAllButtons;

        // Nettoyer l'observer quand la page se ferme
        window.addEventListener('beforeunload', () => {
            observer.disconnect();
        });
    </script>

    <!------------------------------------------- OPTIMISATION LAZY LOADING DES IFRAMES -->
    <script>
        // Lazy loading pour les iframes YouTube
        function setupLazyLoading() {
            const iframes = document.querySelectorAll('iframe[src*="youtube.com"]');

            // Cr√©er un Intersection Observer
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const iframe = entry.target;
                        if (!iframe.dataset.loaded) {
                            iframe.dataset.loaded = 'true';
                            const currentSrc = iframe.src;
                            if (!currentSrc.includes('loading=lazy')) {
                                iframe.src = currentSrc + (currentSrc.includes('?') ? '&' : '?') + 'loading=lazy&rel=0&modestbranding=1';
                            }
                        }
                        observer.unobserve(iframe);
                    }
                });
            }, {
                rootMargin: '200px',
                threshold: 0.01
            });

            iframes.forEach(iframe => {
                observer.observe(iframe);
            });
        }

        function optimizeYouTubeIframes() {
            const mutationObserver = new MutationObserver((mutations) => {
                let newIframes = false;
                mutations.forEach(mutation => {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === 1) {
                            if (node.tagName === 'IFRAME' || node.querySelector('iframe')) {
                                newIframes = true;
                            }
                        }
                    });
                });

                if (newIframes) {
                    setTimeout(setupLazyLoading, 100);
                }
            });

            mutationObserver.observe(document.body, {
                childList: true,
                subtree: true
            });

            setupLazyLoading();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', optimizeYouTubeIframes);
        } else {
            optimizeYouTubeIframes();
        }
    </script>
</body>

</html>
